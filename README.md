# Introduction #
## Overview | Research ##
Пакет для распределенного логирования и трассировки с помощью встроенного пакета slog в Graylog с поддержкой всех используемых средств связи (AMQP, gRPC, HTTP). Под поддержкой имеется ввиду реализацию возможности передачи X-B3 заголовков с помощью встроенных методов со стороны сервера, а также реализацию чтения этих же заголовков со стороны клиента, и дальнейшей передаче их в контекст и создания экземпляра логера с дополнительными X-B3 полями.  

Также в процессе разработки было пересмотрено отношение к X-B3 заголовкам, и так как у нас нет полноценной системы централизованной трассировки, а эту роль выполняет Graylog было принято решение избавиться от всех X-B3 заголовков кроме X-B3-TraceId за ненадобностью и бесполезностью прочих. 

Изучение X-B3 трассировки по Zipkin дало понять, что до этого мы неправильно генерировали X-B3-TraceId, в оригинале это должно быть 64 или 128 битное шестнадцатеричное число, у нас же использовался UUID (исправлено). (https://github.com/openzipkin/b3-propagation)

Был пересмотрен и подробно изучен вопрос передачи логгера для комфортной и быстрой работы с ним, решением стало передача логгера в контексте, выполняющем утилитарную роль.
В следующей статье подробно поднят этот вопрос, ознакомтесь если возникнут вопросы
(https://www.kaznacheev.me/posts/en/where-to-place-logger-in-golang/)  
Теперь необходима передача контекста на всем пути работы программы, несмотря на то, что у нас это не всегда использовалось, это правильный подход.

Самостоятельная реализация и актуализация отправки по прикладному протоколу GELF данных в Graylog позволила уменьшить размер payload, путем устранения deprecated GELF data, которая потеряла актуальность в связи с обновлением протокола GELF и технологии Graylog, соответственно повысилась производительность, помимо этого сам пакет для логирования slog выйгрывает перед логрусом в 10 раз по скорости. (https://github.com/betterstack-community/go-logging-benchmarks?tab=readme-ov-file)

Был реализован утилитарный функционал для пакета slog, позволяющий создать fanout handler, так как slog не умел это из коробки, так же присутствует возможность гибкой настройки логгера как в стандартный вывод, так и в Graylog. Также был затронут UDP Batching, честно говоря я хотел переписать его с нуля, но когда побольше разобрался в этой теме, понял что он и так неплохо реализован, для этого был использован вспомогательный пакет slog-graylog. (https://github.com/samber/slog-graylog)  

В прошлых версиях и всегда использовавшись до этого, Graylog Writer не позволял настроить уровень логов отправляемый в Graylog и под капотом всегда хардкодом проставлял уровень логов как 3 или 6, в зависимости от используемого пакета, теперь же уровень отправляемый с помощью этого пакета всегда фиксируется и корректно доходит до Graylog, можно будет индексировать логи по level: {цифра которая отвечает за конкретный уровень}   (Уровней реализовано 4, так как slog из под капота имеет только 4 уровня).   
## Сопоставление уровней пакета и Graylog ##
| slog    | Graylog |
|---------|---------|
| Debug   | 7       |
| Info    | 6       |
| Warn    | 4       |
| Error   | 3       |

# Usage #

// TODO:  
Проверить AMQP, не уверен  
Проверить gRPC, чуть чуть не уверен  
Дописать как использовать пакет, нужны примеры кода на всё, мб тесты еще написать  
Удалить идея файлы + cmd/main.go